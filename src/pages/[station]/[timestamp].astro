---
import Layout from "../../layouts/Layout.astro";
import { decode } from "html-entities";
import { getStationConfig } from "../../config/stations";

const { station, timestamp } = Astro.params;
const stationConfig = getStationConfig(station!);
if (!stationConfig) {
  return new Response(null, {
    status: 404,
    statusText: "Not found",
  });
}
const {
  audioLoggerUrl,
  stationName,
  stationBluesky,
  stationColor,
  stationColorDark,
  openGraphImage,
  faviconUrl,
  logoUrl,
} = stationConfig;

let dateRegex = /^(\d{4})-(\d{2})-(\d{2})_(\d{2})$/;
if (!timestamp || !dateRegex.test(timestamp)) {
  return new Response(null, {
    status: 404,
    statusText: "Not found",
  });
}

let audioUrl = `${audioLoggerUrl}/${timestamp}.mp3`;

// Check if the audio file exists
let audioResponse = await fetch(audioUrl, { method: "HEAD" });
if (!audioResponse.ok) {
  return new Response(null, {
    status: 404,
    statusText: "Not found",
  });
}

const t = Astro.url.searchParams.get("t");
const e = Astro.url.searchParams.get("e");
let startTime = 0;
let endTime = 0;
if (t) {
  startTime = parseInt(t, 10);
  audioUrl += "#t=" + startTime;
}
if (e) {
  endTime = parseInt(e, 10);
}

// Decoder for HTML entities
function decodeHtmlEntities(text: string): string {
  if (!text) return "";
  return decode(text);
}

let metadataResponse = await fetch(`${audioLoggerUrl}/${timestamp}.meta`);
let showName = decodeHtmlEntities((await metadataResponse.text()).trim());
if (!showName) {
  showName = "Onbekend programma";
}

// Timestamp is in the form of 2024-05-18_11. Convert that into a date object using a regex
let [, year, month, day, hour] = timestamp.match(dateRegex)!;
let showDate = new Date(
  Number(year),
  Number(month) - 1,
  Number(day),
  Number(hour),
);

const title = `${showName} van ${showDate.toLocaleDateString("NL", { dateStyle: "medium" })} om ${showDate.getHours()} uur`;
const description = `Luister ${showName} van ${showDate.toLocaleDateString("NL", { dateStyle: "medium" })} om ${showDate.getHours()} uur op ${stationName} terug.`;
---

<Layout
  brandColor={stationColor}
  brandColorDark={stationColorDark}
  faviconUrl={faviconUrl}
>
  <title slot="head">{title}</title>
  <script
    slot="head"
    is:inline
    defer
    event-station={stationName}
    event-program={showName}
    src="https://stats.zuidwesttv.nl/js/script.pageview-props.js"></script>
  <meta slot="head" name="description" content={description} />
  <meta slot="head" property="og:title" content={`ðŸ“» ${title}`} />
  <meta slot="head" property="og:description" content={description} />
  <meta slot="head" property="og:type" content="music.song" />
  <meta slot="head" property="og:site_name" content={stationName} />
  <meta slot="head" property="og:image" content={openGraphImage} />
  <meta slot="head" property="og:locale" content="nl_NL" />

  <main class="grid min-h-full place-items-center px-4 py-8">
    <div
      class="w-full max-w-2xl overflow-hidden rounded-xl bg-white shadow-md dark:bg-gray-800 dark:shadow-xl"
    >
      <div
        class="from-brand to-brand-dark relative bg-gradient-to-r p-6 text-white"
      >
        <div class="pr-12">
          <h1 class="text-2xl font-bold">{showName}</h1>
          <p class="mt-1 text-sm opacity-90">
            {showDate.toLocaleDateString("nl", { dateStyle: "medium" })}
            {" om "}
            {showDate.toLocaleTimeString("nl", { timeStyle: "short" })}
          </p>
        </div>
        <a
          href={audioUrl}
          class="absolute top-1/2 right-6 -translate-y-1/2 rounded-full bg-white/20 p-2 backdrop-blur transition-all duration-200 hover:bg-white/30 focus:ring-2 focus:ring-white/50 focus:outline-none"
          title="Downloaden"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 20 20"
            fill="currentColor"
            class="size-5"
          >
            <path
              d="M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.235a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 3.129V2.75Z"
            ></path>
            <path
              d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z"
            ></path>
          </svg>
        </a>
      </div>
      <div class="p-6">
        <audio
          id="js-audio"
          src={audioUrl}
          data-start-time={startTime}
          data-end-time={endTime}
          data-show-name={showName}
          data-station-name={stationName}
          data-station-logo={logoUrl}
          data-show-date={showDate.toLocaleDateString("nl", {
            dateStyle: "medium",
          })}></audio>
        <div class="mb-8">
          <div class="flex flex-col items-center space-y-6">
            <button
              id="js-play"
              class="group from-brand to-brand-dark relative size-20 rounded-full bg-gradient-to-br text-white shadow-xl transition-all duration-300 hover:scale-105 hover:shadow-2xl active:scale-95"
            >
              <div
                class="absolute inset-0 rounded-full bg-white opacity-0 transition-opacity duration-300 group-hover:opacity-10"
              >
              </div>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
                class="absolute top-1/2 left-1/2 w-10 -translate-x-1/2 -translate-y-1/2 transition-transform duration-200 group-hover:scale-110 group-data-[state=playing]:hidden"
              >
                <path
                  fill-rule="evenodd"
                  d="M4.5 5.653c0-1.427 1.529-2.33 2.779-1.643l11.54 6.347c1.295.712 1.295 2.573 0 3.286L7.28 19.99c-1.25.687-2.779-.217-2.779-1.643V5.653Z"
                  clip-rule="evenodd"></path>
              </svg>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
                class="absolute top-1/2 left-1/2 hidden w-10 -translate-x-1/2 -translate-y-1/2 transition-transform duration-200 group-hover:scale-110 group-data-[state=playing]:block"
              >
                <path
                  fill-rule="evenodd"
                  d="M6.75 5.25a.75.75 0 0 1 .75-.75H9a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H7.5a.75.75 0 0 1-.75-.75V5.25Zm7.5 0A.75.75 0 0 1 15 4.5h1.5a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H15a.75.75 0 0 1-.75-.75V5.25Z"
                  clip-rule="evenodd"></path>
              </svg>
            </button>

            <div class="w-full space-y-3">
              <div class="relative">
                <!-- Main audio progress bar -->
                <input
                  id="js-audio-track"
                  class="[&::-moz-range-progress]:bg-brand h-2 w-full cursor-pointer appearance-none rounded-full bg-gray-200 dark:bg-gray-700 [&::-moz-range-progress]:h-2 [&::-moz-range-progress]:rounded-full [&::-moz-range-thumb]:h-4 [&::-moz-range-thumb]:w-4 [&::-moz-range-thumb]:cursor-pointer [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:border-0 [&::-moz-range-thumb]:bg-white [&::-moz-range-thumb]:shadow-[0_0_0_1px_rgba(0,0,0,0.1),0_2px_4px_rgba(0,0,0,0.2),0_4px_8px_rgba(0,0,0,0.1)] [&::-moz-range-thumb]:transition-all [&::-moz-range-thumb]:duration-200 [&::-moz-range-thumb]:hover:scale-110 [&::-moz-range-thumb]:hover:shadow-[0_0_0_1px_rgba(0,0,0,0.1),0_2px_6px_rgba(0,0,0,0.3),0_8px_16px_rgba(0,0,0,0.15)] [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-white [&::-webkit-slider-thumb]:shadow-[0_0_0_1px_rgba(0,0,0,0.1),0_2px_4px_rgba(0,0,0,0.2),0_4px_8px_rgba(0,0,0,0.1)] [&::-webkit-slider-thumb]:transition-all [&::-webkit-slider-thumb]:duration-200 [&::-webkit-slider-thumb]:hover:scale-110 [&::-webkit-slider-thumb]:hover:shadow-[0_0_0_1px_rgba(0,0,0,0.1),0_2px_6px_rgba(0,0,0,0.3),0_8px_16px_rgba(0,0,0,0.15)]"
                  type="range"
                  max="100"
                  value="0"
                  style="background-image: linear-gradient(to right, var(--brand-color) 0%, var(--brand-color) 0%, #e5e7eb 0%, #e5e7eb 100%)"
                />
                
                <!-- Clip range visualization -->
                <div id="js-clip-range" class="absolute top-0 h-2 bg-blue-400/30 rounded-full pointer-events-none hidden border border-blue-400/50"></div>
                
                <!-- Interactive clip markers -->
                <div class="absolute -top-1 w-full h-4 pointer-events-none">
                  <!-- Start marker -->
                  <div id="js-start-marker" class="absolute top-0 w-4 h-4 bg-emerald-500 rounded-full border-2 border-white shadow-lg cursor-grab pointer-events-auto transform -translate-x-2 hover:scale-110 transition-all duration-200 hidden active:cursor-grabbing">
                    <div class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-emerald-500 text-white text-xs px-2 py-1 rounded-md whitespace-nowrap shadow-md">
                      <span class="js-start-time">0:00</span>
                      <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-2 border-r-2 border-t-2 border-transparent border-t-emerald-500"></div>
                    </div>
                  </div>
                  
                  <!-- End marker -->
                  <div id="js-end-marker" class="absolute top-0 w-4 h-4 bg-red-500 rounded-full border-2 border-white shadow-lg cursor-grab pointer-events-auto transform -translate-x-2 hover:scale-110 transition-all duration-200 hidden active:cursor-grabbing">
                    <div class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-red-500 text-white text-xs px-2 py-1 rounded-md whitespace-nowrap shadow-md">
                      <span class="js-end-time">0:00</span>
                      <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-2 border-r-2 border-t-2 border-transparent border-t-red-500"></div>
                    </div>
                  </div>
                </div>
              </div>
              <div
                class="flex items-center justify-between text-sm text-gray-600 dark:text-gray-300"
              >
                <span class="js-current-time font-medium tabular-nums"
                  >00:00</span
                >
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <button
                      id="js-clip-mode-toggle"
                      class="inline-flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 shadow-sm transition-all hover:bg-gray-50 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200 dark:hover:bg-gray-700"
                      title="Activeer clipping modus"
                    >
                      <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                      </svg>
                      Clip maken
                    </button>
                    <button
                      id="js-play-clip"
                      class="inline-flex items-center gap-1.5 rounded-lg bg-blue-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm transition-all hover:bg-blue-700 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed hidden"
                      title="Speel alleen geselecteerde clip af"
                    >
                      <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.5 5.653c0-1.427 1.529-2.33 2.779-1.643l11.54 6.347c1.295.712 1.295 2.573 0 3.286L7.28 19.99c-1.25.687-2.779-.217-2.779-1.643V5.653Z" clip-rule="evenodd"/>
                      </svg>
                      Afspelen
                    </button>
                  </div>
                  <span id="js-duration" class="font-medium tabular-nums text-gray-500 dark:text-gray-400"
                    >0:00</span
                  >
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="border-t border-gray-200 pt-6 dark:border-gray-700">
          <p
            class="mb-4 text-sm font-semibold tracking-wider text-gray-600 uppercase dark:text-gray-300"
          >
            Deel dit op
          </p>
          <div class="-m-1 mb-2 flex flex-wrap items-center">
            <a
              id="js-share-bluesky"
              href="#"
              target="_blank"
              class="text-social-bluesky border-social-bluesky m-1 flex items-center rounded-lg border px-2 py-1 text-sm transition-all duration-200 hover:shadow-md"
              data-bluesky-handle={stationBluesky}
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 600 530"
                class="mr-1.5 fill-current"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="m135.72 44.03c66.496 49.921 138.02 151.14 164.28 205.46 26.262-54.316 97.782-155.54 164.28-205.46 47.98-36.021 125.72-63.892 125.72 24.795 0 17.712-10.155 148.79-16.111 170.07-20.703 73.984-96.144 92.854-163.25 81.433 117.3 19.964 147.14 86.092 82.697 152.22-122.39 125.59-175.91-31.511-189.63-71.766-2.514-7.3797-3.6904-10.832-3.7077-7.8964-0.0174-2.9357-1.1937 0.51669-3.7077 7.8964-13.714 40.255-67.233 197.36-189.63 71.766-64.444-66.128-34.605-132.26 82.697-152.22-67.108 11.421-142.55-7.4491-163.25-81.433-5.9562-21.282-16.111-152.36-16.111-170.07 0-88.687 77.742-60.816 125.72-24.795z"
                ></path>
              </svg>
              Bluesky</a
            >
            <a
              id="js-share-facebook"
              href="#"
              target="_blank"
              class="text-social-facebook dark:text-social-facebook-dark border-social-facebook dark:border-social-facebook-dark m-1 flex items-center rounded-lg border px-2 py-1 text-sm transition-all duration-200 hover:shadow-md"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                class="mr-1.5 fill-current"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M9.198 21.5h4v-8.01h3.604l.396-3.98h-4V7.5a1 1 0 0 1 1-1h3v-4h-3a5 5 0 0 0-5 5v2.01h-2l-.396 3.98h2.396v8.01z"
                ></path>
              </svg>
              Facebook</a
            >
            <a
              id="js-share-whatsapp"
              href="#"
              class="text-social-whatsapp border-social-whatsapp m-1 flex items-center rounded-lg border px-2 py-1 text-sm transition-all duration-200 hover:shadow-md"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                class="mr-1.5 fill-current"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"
                ></path>
              </svg>
              WhatsApp</a
            >
            <a
              id="js-share-mail"
              href="#"
              class="text-social-email dark:text-social-email-dark border-social-email dark:border-social-email-dark m-1 flex flex-none items-center rounded-lg border px-2 py-1 text-sm whitespace-nowrap transition-all duration-200 hover:shadow-md"
            >
              <svg
                width="16"
                height="16"
                class="mr-1.5 fill-current"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
              >
                <path
                  d="M 12 2 C 6.4886661 2 2 6.4886661 2 12 C 2 17.511334 6.4886661 22 12 22 L 16 22 A 1.0001 1.0001 0 1 0 16 20 L 12 20 C 7.5693339 20 4 16.430666 4 12 C 4 7.5693339 7.5693339 4 12 4 C 16.430666 4 20 7.5693339 20 12 L 20 13.5 C 20 14.340812 19.340812 15 18.5 15 C 17.659188 15 17 14.340812 17 13.5 L 17 12 A 1.0001 1.0001 0 0 0 16.994141 11.888672 C 16.933859 9.1903924 14.712044 7 12 7 C 9.2504209 7 7 9.2504209 7 12 C 7 14.749579 9.2504209 17 12 17 C 13.413556 17 14.687859 16.398875 15.599609 15.447266 C 16.230695 16.380863 17.297708 17 18.5 17 C 20.421188 17 22 15.421188 22 13.5 L 22 12 C 22 6.4886661 17.511334 2 12 2 z M 12 9 C 13.668699 9 15 10.331301 15 12 C 15 13.668699 13.668699 15 12 15 C 10.331301 15 9 13.668699 9 12 C 9 10.331301 10.331301 9 12 9 z"
                ></path>
              </svg>
              E-mail</a
            >
          </div>
          <div class="mt-4 rounded-lg bg-gray-50 p-4 dark:bg-gray-700">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2">
                <svg class="h-5 w-5 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                  <polyline points="16,6 12,2 8,6"/>
                  <line x1="12" y1="2" x2="12" y2="15"/>
                </svg>
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Delen</span>
              </div>
              <div id="js-clip-info" class="text-xs text-gray-500 dark:text-gray-400 hidden">
                <span class="inline-flex items-center gap-1 bg-blue-100 text-blue-700 px-2 py-1 rounded-full dark:bg-blue-900 dark:text-blue-300">
                  <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                  </svg>
                  <span class="js-clip-duration font-medium">0:00</span>
                </span>
              </div>
            </div>
            
            <div id="js-share-options" class="space-y-2">
              <div class="flex items-center justify-between text-sm text-gray-600 dark:text-gray-300">
                <span>Deel type:</span>
                <select id="js-share-type" class="rounded border border-gray-300 bg-white px-2 py-1 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200">
                  <option value="full">Hele uitzending</option>
                  <option value="from-current">Vanaf huidige positie</option>
                  <option value="clip">Geselecteerde clip</option>
                </select>
              </div>
              
              <div id="js-share-info" class="text-xs text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-600 rounded p-2">
                <span class="js-share-description">Link naar hele uitzending</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  const calculateTime = (secs: number) => {
    const minutes = ("0" + Math.floor(secs / 60)).slice(-2);
    const seconds = ("0" + Math.floor(secs % 60)).slice(-2);
    return `${minutes}:${seconds}`;
  };

  const updateCurrentTime = () => {
    for (const container of currentTimeContainers) {
      container.textContent = calculateTime(Number(seekSlider.value));
    }
    // Update slider progress visual
    const percentage =
      (Number(seekSlider.value) / Number(seekSlider.max)) * 100;
    const isDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    const bgColor = isDark ? "#374151" : "#e5e7eb";
    seekSlider.style.backgroundImage = `linear-gradient(to right, var(--brand-color) 0%, var(--brand-color) ${percentage}%, ${bgColor} ${percentage}%, ${bgColor} 100%)`;
    
    // Update share description if showing current time
    if (shareTypeSelect && shareTypeSelect.value === 'from-current') {
      updateShareDescription();
    }
  };

  const updateStartTime = () => {
    for (const container of startTimeContainers) {
      container.textContent = calculateTime(clipStartTime);
    }
  };

  const updateEndTime = () => {
    for (const container of endTimeContainers) {
      container.textContent = calculateTime(clipEndTime);
    }
  };

  const updateClipDuration = () => {
    if (clipStartTime < clipEndTime) {
      const duration = clipEndTime - clipStartTime;
      for (const container of clipDurationContainers) {
        container.textContent = calculateTime(duration);
      }
    }
  };

  const updateShareDescription = () => {
    if (!shareTypeSelect) return;
    
    const shareType = shareTypeSelect.value;
    switch (shareType) {
      case 'full':
        shareDescription.textContent = 'Link naar hele uitzending';
        break;
      case 'from-current':
        shareDescription.textContent = `Link vanaf ${calculateTime(Number(seekSlider.value))}`;
        break;
      case 'clip':
        if (isClipMode) {
          const startTime = calculateTime(clipStartTime);
          const endTime = calculateTime(clipEndTime);
          shareDescription.textContent = `Link naar clip (${startTime} - ${endTime})`;
        } else {
          shareDescription.textContent = 'Maak eerst een clip om deze optie te gebruiken';
        }
        break;
    }
  };

  const updateClipVisuals = () => {
    if (!isClipMode) return;
    
    const maxValue = Number(seekSlider.max);
    
    // Calculate positions
    const startPercent = (clipStartTime / maxValue) * 100;
    const endPercent = (clipEndTime / maxValue) * 100;
    
    // Check if markers would overlap (within 5% of each other)
    const percentDiff = Math.abs(endPercent - startPercent);
    const minDistance = 8; // Minimum distance in percentage
    
    if (percentDiff < minDistance) {
      // Offset the end marker slightly to prevent overlap
      const offsetPercent = minDistance - percentDiff;
      if (startPercent < endPercent) {
        endMarker.style.left = `${Math.min(100, endPercent + offsetPercent)}%`;
      } else {
        startMarker.style.left = `${Math.max(0, startPercent - offsetPercent)}%`;
      }
    } else {
      startMarker.style.left = `${startPercent}%`;
      endMarker.style.left = `${endPercent}%`;
    }
    
    // Update clip range visualization
    const rangeLeft = Math.min(startPercent, endPercent);
    const rangeWidth = Math.abs(endPercent - startPercent);
    clipRange.style.left = `${rangeLeft}%`;
    clipRange.style.width = `${rangeWidth}%`;
    
    updateClipDuration();
    updateStartTime();
    updateEndTime();
  };

  const toggleClipMode = () => {
    isClipMode = !isClipMode;
    
    if (isClipMode) {
      // Initialize clip times
      clipStartTime = Number(seekSlider.value);
      clipEndTime = Math.min(clipStartTime + 60, Number(seekSlider.max)); // Default 60 second clip
      
      // Show clip UI elements
      startMarker.classList.remove('hidden');
      endMarker.classList.remove('hidden');
      clipRange.classList.remove('hidden');
      playClipButton.classList.remove('hidden');
      clipInfo.classList.remove('hidden');
      
      // Update button appearance
      clipModeToggle.innerHTML = `
        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 18L18 6M6 6l12 12"/>
        </svg>
        Exit Clip
      `;
      clipModeToggle.title = 'Verlaat clipping modus';
      clipModeToggle.className = 'inline-flex items-center gap-1.5 rounded-lg border border-red-300 bg-red-50 px-3 py-1.5 text-sm font-medium text-red-700 shadow-sm transition-all hover:bg-red-100 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:border-red-600 dark:bg-red-900 dark:text-red-200 dark:hover:bg-red-800';
      
      // Auto-select clip option
      if (shareTypeSelect) {
        shareTypeSelect.value = 'clip';
      }
      
      // Update visuals
      updateClipVisuals();
    } else {
      // Hide clip UI elements
      startMarker.classList.add('hidden');
      endMarker.classList.add('hidden');
      clipRange.classList.add('hidden');
      playClipButton.classList.add('hidden');
      clipInfo.classList.add('hidden');
      
      // Update button appearance
      clipModeToggle.innerHTML = `
        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
        </svg>
        Clip maken
      `;
      clipModeToggle.title = 'Activeer clipping modus';
      clipModeToggle.className = 'inline-flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 shadow-sm transition-all hover:bg-gray-50 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200 dark:hover:bg-gray-700';
      
      // Reset share type if it was set to clip
      if (shareTypeSelect && shareTypeSelect.value === 'clip') {
        shareTypeSelect.value = 'full';
      }
    }
    
    updateShareDescription();
    updateSharelinks();
  };

  const setupDragAndDrop = () => {
    // Helper function to get time from mouse position
    const getTimeFromMouseX = (mouseX: number) => {
      const sliderRect = seekSlider.getBoundingClientRect();
      const relativeX = mouseX - sliderRect.left;
      const percentage = Math.max(0, Math.min(1, relativeX / sliderRect.width));
      return percentage * Number(seekSlider.max);
    };

    // Mouse down on markers
    const handleMarkerMouseDown = (e: MouseEvent, target: 'start' | 'end') => {
      if (!isClipMode) return;
      e.preventDefault();
      isDragging = true;
      dragTarget = target;
      document.body.style.cursor = 'grabbing';
      
      // Add temporary event listeners for mouse move and up
      const handleMouseMove = (e: MouseEvent) => {
        if (!isDragging || !dragTarget) return;
        
        const newTime = getTimeFromMouseX(e.clientX);
        
        if (dragTarget === 'start') {
          clipStartTime = Math.max(0, Math.min(newTime, clipEndTime - 1));
        } else {
          clipEndTime = Math.max(clipStartTime + 1, Math.min(newTime, Number(seekSlider.max)));
        }
        
        updateClipVisuals();
        updateShareDescription();
        updateSharelinks();
      };
      
      const handleMouseUp = () => {
        isDragging = false;
        dragTarget = null;
        document.body.style.cursor = '';
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      };
      
      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
    };

    // Click on slider to set markers
    const handleSliderClick = (e: MouseEvent) => {
      if (!isClipMode) return;
      
      const clickTime = getTimeFromMouseX(e.clientX);
      
      // Determine which marker to move based on proximity
      const startDistance = Math.abs(clickTime - clipStartTime);
      const endDistance = Math.abs(clickTime - clipEndTime);
      
      if (startDistance < endDistance) {
        clipStartTime = Math.max(0, Math.min(clickTime, clipEndTime - 1));
      } else {
        clipEndTime = Math.max(clipStartTime + 1, Math.min(clickTime, Number(seekSlider.max)));
      }
      
      updateClipVisuals();
      updateShareDescription();
      updateSharelinks();
    };

    // Event listeners
    startMarker.addEventListener('mousedown', (e) => handleMarkerMouseDown(e, 'start'));
    endMarker.addEventListener('mousedown', (e) => handleMarkerMouseDown(e, 'end'));
    
    // Double click on slider to set markers
    seekSlider.addEventListener('dblclick', handleSliderClick);
  };

  const whilePlaying = () => {
    seekSlider.value = "" + Math.floor(audio.currentTime);
    updateCurrentTime();
    
    // Check if clip mode is active and we've reached the clip end time
    if (isClipMode && shareTypeSelect && shareTypeSelect.value === 'clip' && audio.currentTime >= clipEndTime) {
      audio.pause();
      return;
    }
    
    // Update media session position periodically if duration is known
    if ('mediaSession' in navigator && 'setPositionState' in navigator.mediaSession) {
      if (isFinite(audio.duration) && audio.duration > 0) {
        try {
          navigator.mediaSession.setPositionState({
            duration: audio.duration,
            playbackRate: audio.playbackRate,
            position: audio.currentTime
          });
        } catch (error) {
          // Silently ignore to avoid console noise
        }
      }
    }
    
    raf = requestAnimationFrame(whilePlaying);
  };

  const initPlayer = () => {
    audio.currentTime = audio.dataset.startTime
      ? Number(audio.dataset.startTime)
      : 0;
    seekSlider.max = "" + Math.floor(audio.duration);
    seekSlider.value = "" + Math.floor(audio.currentTime);
    updateCurrentTime();
    durationContainer.textContent = calculateTime(audio.duration);
    
    // Initialize end time if provided
    if (audio.dataset.endTime) {
      endTimeSlider = Number(audio.dataset.endTime);
      clipEndTime = endTimeSlider;
      updateEndTime();
    } else {
      endTimeSlider = audio.duration;
      clipEndTime = audio.duration;
      updateEndTime();
    }
    
    // Initialize share type based on URL parameters
    if (shareTypeSelect) {
      if (audio.dataset.startTime && audio.dataset.endTime) {
        shareTypeSelect.value = 'clip';
        // Auto-activate clip mode if both start and end times are provided
        if (!isClipMode) {
          clipStartTime = Number(audio.dataset.startTime);
          clipEndTime = Number(audio.dataset.endTime);
          toggleClipMode();
        }
      } else if (audio.dataset.startTime) {
        shareTypeSelect.value = 'from-current';
      } else {
        shareTypeSelect.value = 'full';
      }
    }
    
    // Initialize share description
    updateShareDescription();
  };

  const updateSharelinks = () => {
    let link = new URL(window.location.href);
    link.searchParams.set("utm_medium", "social");
    link.searchParams.set("utm_campaign", "sharebutton");
    
    if (!shareTypeSelect) return;
    
    const shareType = shareTypeSelect.value;
    
    // Clear existing parameters
    link.searchParams.delete("t");
    link.searchParams.delete("e");
    
    // Add parameters based on share type
    switch (shareType) {
      case 'from-current':
        link.searchParams.set("t", `${Math.floor(Number(seekSlider.value))}s`);
        break;
      case 'clip':
        if (isClipMode) {
          link.searchParams.set("t", `${Math.floor(clipStartTime)}s`);
          link.searchParams.set("e", `${Math.floor(clipEndTime)}s`);
        }
        break;
      // 'full' doesn't add any parameters
    }

    const shareBluesky = document.getElementById(
      "js-share-bluesky",
    ) as HTMLAnchorElement;
    const shareFacebook = document.getElementById(
      "js-share-facebook",
    ) as HTMLAnchorElement;
    const shareWhatsapp = document.getElementById(
      "js-share-whatsapp",
    ) as HTMLAnchorElement;
    const shareMail = document.getElementById(
      "js-share-mail",
    ) as HTMLAnchorElement;

    // Bluesky
    const blueskyLink = new URL(link);
    blueskyLink.searchParams.set("utm_source", "Bluesky");

    const blueskyShareUrl = new URL("https://bsky.app/intent/compose");
    blueskyShareUrl.searchParams.set("text", blueskyLink.toString());
    shareBluesky.href = blueskyShareUrl.toString();

    // Facebook
    const facebookLink = new URL(link);
    facebookLink.searchParams.set("utm_source", "Facebook");

    const facebookShareUrl = new URL("https://www.facebook.com/sharer.php");
    facebookShareUrl.searchParams.set("u", facebookLink.toString());
    shareFacebook.href = facebookShareUrl.toString();

    // WhatsApp
    const whatsAppLink = new URL(link);
    whatsAppLink.searchParams.set("utm_source", "WhatsApp");

    const whatsAppShareUrl = new URL("whatsapp://send");
    whatsAppShareUrl.searchParams.set("text", whatsAppLink.toString());
    shareWhatsapp.href = whatsAppShareUrl.toString();

    // Mail
    const mailLink = new URL(link);
    mailLink.searchParams.set("utm_source", "E-mail");

    const mailShareUrl = new URL("mailto:");
    mailShareUrl.searchParams.set("body", mailLink.toString());
    shareMail.href = mailShareUrl.toString();
  };

  const audio = document.getElementById("js-audio") as HTMLAudioElement;
  const seekSlider = document.getElementById(
    "js-audio-track",
  ) as HTMLInputElement;
  const durationContainer = document.getElementById(
    "js-duration",
  ) as HTMLSpanElement;
  const currentTimeContainers =
    document.getElementsByClassName("js-current-time");
  const clipDurationContainers =
    document.getElementsByClassName("js-clip-duration");
  const startTimeContainers =
    document.getElementsByClassName("js-start-time");
  const endTimeContainers =
    document.getElementsByClassName("js-end-time");
  const playIconContainer = document.getElementById(
    "js-play",
  ) as HTMLSpanElement;
  const shareTypeSelect = document.getElementById(
    "js-share-type",
  ) as HTMLSelectElement | null;
  const shareDescription = document.querySelector(
    ".js-share-description",
  ) as HTMLSpanElement;
  
  // Interactive clipping elements
  const clipModeToggle = document.getElementById("js-clip-mode-toggle") as HTMLButtonElement;
  const playClipButton = document.getElementById("js-play-clip") as HTMLButtonElement;
  const clipRange = document.getElementById("js-clip-range") as HTMLDivElement;
  const startMarker = document.getElementById("js-start-marker") as HTMLDivElement;
  const endMarker = document.getElementById("js-end-marker") as HTMLDivElement;
  const clipInfo = document.getElementById("js-clip-info") as HTMLDivElement;
  
  let raf: number | null = null;
  let endTimeSlider: number = 0;
  let clipStartTime: number = 0;
  let clipEndTime: number = 0;
  let isClipMode: boolean = false;
  let isDragging: boolean = false;
  let dragTarget: 'start' | 'end' | null = null;

  // Media Session API setup
  if ("mediaSession" in navigator) {
    const showName = audio.dataset.showName || "Onbekend programma";
    const stationName = audio.dataset.stationName || "";
    const stationLogo = audio.dataset.stationLogo || "";
    const showDate = audio.dataset.showDate || "";

    navigator.mediaSession.metadata = new MediaMetadata({
      title: showName,
      artist: stationName,
      album: `Uitzending van ${showDate}`,
      artwork: [
        { src: stationLogo, sizes: "96x96", type: "image/png" },
        { src: stationLogo, sizes: "128x128", type: "image/png" },
        { src: stationLogo, sizes: "192x192", type: "image/png" },
        { src: stationLogo, sizes: "256x256", type: "image/png" },
        { src: stationLogo, sizes: "384x384", type: "image/png" },
        { src: stationLogo, sizes: "512x512", type: "image/png" },
      ],
    });

    navigator.mediaSession.setActionHandler("play", () => {
      audio.play();
    });

    navigator.mediaSession.setActionHandler("pause", () => {
      audio.pause();
    });

    navigator.mediaSession.setActionHandler("seekbackward", (details) => {
      const skipTime = details.seekOffset || 10;
      audio.currentTime = Math.max(audio.currentTime - skipTime, 0);
    });

    navigator.mediaSession.setActionHandler("seekforward", (details) => {
      const skipTime = details.seekOffset || 10;
      audio.currentTime = Math.min(
        audio.currentTime + skipTime,
        audio.duration,
      );
    });

    navigator.mediaSession.setActionHandler("seekto", (details) => {
      if (details.fastSeek && "fastSeek" in audio) {
        audio.fastSeek(details.seekTime!);
        return;
      }
      audio.currentTime = details.seekTime!;
    });
  }

  playIconContainer.addEventListener("click", () => {
    if (audio.paused) {
      audio.play();
      raf = requestAnimationFrame(whilePlaying);
    } else {
      audio.pause();
      if (raf) {
        cancelAnimationFrame(raf);
      }
    }
  });

  if (shareTypeSelect) {
    shareTypeSelect.addEventListener("change", () => {
      updateShareDescription();
      updateSharelinks();
    });
  }

  // Clip mode toggle functionality
  clipModeToggle.addEventListener("click", toggleClipMode);
  
  // Play clip functionality
  playClipButton.addEventListener("click", () => {
    if (isClipMode) {
      audio.currentTime = clipStartTime;
      if (shareTypeSelect) {
        shareTypeSelect.value = 'clip';
      }
      updateShareDescription();
      updateSharelinks();
      audio.play();
    }
  });

  if (audio.readyState > 0) {
    initPlayer();
    updateSharelinks();
    setupDragAndDrop();
  } else {
    audio.addEventListener("loadedmetadata", () => {
      initPlayer();
      updateSharelinks();
      setupDragAndDrop();
      
      // Update media session position state when duration is known
      if ('mediaSession' in navigator && 'setPositionState' in navigator.mediaSession) {
        if (isFinite(audio.duration) && audio.duration > 0) {
          try {
            navigator.mediaSession.setPositionState({
              duration: audio.duration,
              playbackRate: audio.playbackRate,
              position: audio.currentTime
            });
          } catch (error) {
            // Silently ignore to avoid console noise
          }
        }
      }
    });
  }

  audio.addEventListener("play", () => {
    playIconContainer.dataset.state = "playing";

    // If user seeked before playing, apply the seek time
    if (userSeekedBeforePlay && targetSeekTime > 0) {
      // Use playing event to ensure audio is ready on iOS
      const applySeek = () => {
        audio.currentTime = targetSeekTime;
        userSeekedBeforePlay = false;
        audio.removeEventListener("playing", applySeek);
      };
      audio.addEventListener("playing", applySeek, { once: true });
    }
  });

  audio.addEventListener("pause", () => {
    playIconContainer.dataset.state = "paused";
  });

  audio.addEventListener("stop", () => {
    playIconContainer.dataset.state = "stopped";
  });

  let userSeekedBeforePlay = false;
  let targetSeekTime = 0;

  seekSlider.addEventListener("input", () => {
    updateCurrentTime();
    if (!audio.paused) {
      if (raf) {
        cancelAnimationFrame(raf);
      }
    }
  });

  seekSlider.addEventListener("change", () => {
    targetSeekTime = Number(seekSlider.value);
    userSeekedBeforePlay = true;

    // Try to set currentTime if audio is ready
    if (audio.readyState >= 2) {
      audio.currentTime = targetSeekTime;
      userSeekedBeforePlay = false;
    }

    if (!audio.paused) {
      requestAnimationFrame(whilePlaying);
    }
  });

  // Listen for dark mode changes
  window
    .matchMedia("(prefers-color-scheme: dark)")
    .addEventListener("change", () => {
      updateCurrentTime();
    });

  // Set initial progress state
  updateCurrentTime();
</script>
